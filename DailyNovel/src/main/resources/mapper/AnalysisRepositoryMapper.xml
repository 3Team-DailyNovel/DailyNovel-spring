<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dailynovel.web.repository.AnalysisRepository">

	<resultMap id="HonestyMap" type="Honesty">
		 <result property="honestyRange" column="honesty_range"/>
		</resultMap>
	
	
	<select id="findCount" resultType="Feeling">
		SELECT f.name, f.img, count(d.feeling_id) as frequency
		FROM feeling f
		LEFT JOIN diary d ON f.id = d.feeling_id AND d.member_id = 1
		group by f.name
		ORDER BY frequency DESC;
	</select>

	

	<select id="findFeelingTopRank" resultType="Feeling">
		SELECT name, img, frequency, description
		FROM feeling_view
		where member_id = 1
		group by name
		ORDER BY frequency DESC
	</select>
	

	<select id="findFeelingRank" resultType="Feeling">
		SELECT img, name, frequency, DENSE_RANK() OVER (ORDER BY frequency DESC) as ranking
		FROM feeling_view
		where member_id = 1
		GROUP BY id
		ORDER BY frequency DESC
		LIMIT 1,4;
	</select>
	
	<select id="findValue" resultType="Feeling">
		SELECT name, frequency
		FROM feeling_view
		where member_id = 1
		GROUP BY name
		ORDER BY frequency DESC;
	</select>
	
	<select id="findHonesty" resultMap="HonestyMap">
    SELECT
    CASE
        WHEN honesty BETWEEN 0 AND 20 THEN '0-20'
        WHEN honesty BETWEEN 21 AND 40 THEN '21-40'
        WHEN honesty BETWEEN 41 AND 60 THEN '41-60'
        WHEN honesty BETWEEN 61 AND 80 THEN '61-80'
        WHEN honesty BETWEEN 81 AND 100 THEN '81-100'
	    END AS honesty_range,
	    COUNT(*) AS count
		FROM diary
		WHERE member_id = 1 AND honesty IS NOT NULL
		GROUP BY honesty_range
		ORDER BY honesty_range ASC;
	</select>
	
	<select id ="findHow" resultType="How">
	select t.name, d.member_id, count(d.template_id) as count
	from template t
	inner join diary d on d.template_id = t.id
	group by t.name, d.member_id
	having d.member_id = 1
	order by count DESC;
	</select>
	
	<select id ="findTopHow" resultType="How">
	select t.name, d.member_id, count(d.template_id) as count, t.description
	from template t
	inner join diary d on d.template_id = t.id
	group by t.name, d.member_id
	having d.member_id = 1
	order by count DESC;
	</select>
	
	
	


</mapper>